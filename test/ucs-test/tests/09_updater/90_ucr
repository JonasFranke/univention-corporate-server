#!/usr/share/ucs-test/runner bash
## desc: |
##  Check version/{version,patchlevel} is set correctly by univention-updater.postinst
## bugs: [41165]
## versions:
##  4.1-1: found
##  4.1-2: fixed
## tags: [basic]
## exposure: dangerous

# shellcheck source=/dev/null
. "$TESTLIBPATH/base.sh" || exit 137

tmp="$(mktemp)"
trap 'rm -f "$tmp"; ucr commit /etc/ldap/slapd.conf; systemctl restart slapd.service' EXIT
grep -v "^version/" /etc/univention/base.conf > "$tmp"
UNIVENTION_BASECONF="$tmp" dpkg-reconfigure univention-updater || :
dpkg-reconfigure univention-updater

result=0
for var in version patchlevel # erratalevel
do
	var="version/$var"
	cur="$(ucr get "$var")"
	new="$(UNIVENTION_BASECONF="$tmp" ucr get "$var")"
	verify_value "$var" "$new" "$cur" || result=$?
done
exit $result

# vim:set ft=sh:
