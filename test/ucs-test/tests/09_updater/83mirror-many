#!/usr/share/ucs-test/runner bash
## desc: |
##  Mirror localhost with many upstream releases
##    Note: The current naming scheme doesn't work with patchlevel or minor release numbers > 9
##  1. Create  mirror with 28 updates, using hard-links
## roles-not: [basesystem]
## tags: [basic]
## packages:
##  - apache2 | apache2-mpm-prefork
##  - apt-mirror
## bugs: [51588]
## versions:
##  5.0-0: fixed
## exposure: dangerous

RETVAL=121 # Bug vorhanden, wie vermutet
. pool.sh || exit 137

setup_apache "${repoprefix}"

# Create a package that will be used for all subsequent releases
mkpdir "1.0-0" maintained "${ARCH}"
mkdeb "${pkgname}" 1 "${ARCH}" "${DIR_POOL}"
mkpkg "${DIRS[0]}" "${DIR_POOL}"
mksh "${DIRS[0]}"/../.. preup postup
declare -a DOKAY=()

echo -n "Creating patchlevel..."
for ((pat=1;pat<=9;pat+=1)) # 0 created by minor
do
	mkpdir "${major}.${minor}-${pat}" maintained "${ARCH}"
	mksh "${DIRS[*]: -2:1}"/../.. preup postup
	DOKAY+=(${DIRS[@]: -1:2})
done
echo -n " minor..."
for ((min=1;min<=9;min+=1)) # 0 is master
do
	mkpdir "${major}.${min}-0" maintained "${ARCH}"
	mksh "${DIRS[*]: -2:1}"/../.. preup postup
	DOKAY+=("${DIRS[@]: -1:2}")
done
echo -n " major..."
for ((maj=5;maj<=9;maj+=1)) # major < 5 was using a different repo structure
do
	mkpdir "${maj}.0-0" maintained "${ARCH}"
	mksh "${DIRS[*]: -2:1}"/../.. preup postup
	DOKAY+=("${DIRS[@]: -1:2}")
done
echo " done."

config_mirror \
	repository/mirror/version/start="5.0-0" \
	repository/mirror/version/end="9.9-9" \
	repository/online/unmaintained=no \
	repository/mirorr=yes
(
	set -e
	echo "Checking /etc/apt/mirror.list for ${#DOKAY[@]} required entries..."
	checkapt --mirror "http://localhost\(:80\)\?/${repoprefix}/" "${DOKAY[@]}"
	echo "Doing mirror..."
	wait_for_updater_lock
	univention-repository-update net
	echo "Checking mirror..."
	checkmirror "${DOKAY[@]}"
)
[ $? -eq 0 ] && RETVAL=100 # Test bestanden (Keine Fehler)

exit ${RETVAL}
# vim:set ft=sh:
