#!/usr/share/ucs-test/runner /usr/share/ucs-test/selenium
# -*- coding: utf-8 -*-
## desc: Test adding portal categories and entries from within the portal
## roles:
##  - domaincontroller_master
## tags:
##  - skip_admember
## join: true
## exposure: dangerous

import logging
import time

from univention.testing import selenium
import univention.testing.ucr as ucr_test
from univention.testing.udm import UCSTestUDM
import univention.testing.strings as uts
from univention.admin import localization
from univention.udm import UDM, NoObject
from univention.testing.selenium.utils import expand_path
from selenium.common.exceptions import NoSuchElementException

logger = logging.getLogger(__name__)

translator = localization.translation('ucs-test-selenium')
_ = translator.translate


class CreationError(Exception):
	pass


class UMCTester(object):

	def test_umc(self):
		try:
			self.init()
			self.do_test()
		finally:
			self.cleanup()

	def init(self):
		logger.info('Creating dummy portal')
		self.dummy_portal_title = uts.random_string()
		self.dummy_portal_dn = self.udm_test.create_object(
			'portals/portal',
			name=uts.random_string(),
			displayName=['en_US ' + self.dummy_portal_title],
			portalComputers=[ucr.get('ldap/hostdn')],
		)
		logger.info('Saving previously set portalComputers of main portal')
		udm = UDM.admin().version(1)
		portal = udm.obj_by_dn('cn=domain,cn=portal,cn=portals,cn=univention,{}'.format(ucr.get('ldap/base')))
		self.prev_comps = portal.props.portalComputers
		portal.props.portalComputers = []
		portal.save()

	def do_test(self):
		self.selenium.do_login()

		logger.info('Visiting dummy portal')
		self.selenium.driver.get(self.selenium.base_url)
		self.selenium.wait_for_text(self.dummy_portal_title)

		logger.info('Enter edit mode')
		self.selenium.click_element(expand_path('//*[@containsClass="iconMenu"]'))
		self.selenium.click_button(_('Edit Portal'))

		udm = UDM.admin().version(1)
		logger.info('Create category')
		self.cat_name = uts.random_string()  # not sure if using random strings here is a good idea
		cat_dname = uts.random_string()
		self.selenium.click_button('Add category')
		self.selenium.wait_for_text('Create new category')
		self.selenium.click_text('Create new category')
		self.selenium.wait_for_text('Internal name *')
		self.selenium.enter_input('name', self.cat_name)
		self.selenium.enter_input('__displayName-0-1', cat_dname)
		self.selenium.click_button('Save')
		self.selenium.wait_until_all_dialogues_closed()
		self.selenium.wait_until_all_standby_animations_disappeared()

		logger.info('Check if the category was created')
		try:
			self.selenium.wait_until_element_visible('//h2[text()="%s"]' % (cat_dname), timeout=10)
			udm.obj_by_dn('cn=%s,cn=category,cn=portals,cn=univention,%s' % (self.cat_name, self.ucr['ldap/base']))
		except NoSuchElementException:
			try:
				udm.obj_by_dn('cn=%s,cn=category,cn=portals,cn=univention,%s' % (self.cat_name, self.ucr['ldap/base']))
			except NoObject:
				raise CreationError('Creation of the settings/portal_category UDM object failed')
			raise CreationError('A settings/portal_category UDM object was created but the category was not immediately visible in the portal')
		except NoObject:
			raise CreationError('Creation of the settings/portal_category UDM object failed')

		logger.info('Create entry')
		self.selenium.click_element(expand_path('//h2[text()="%s"]/following-sibling::*[1]//*[@containsClass="portalAddEntryButton"]' % (cat_dname)))
		self.selenium.wait_for_text('Add entry')
		self.selenium.click_text('Add entry')
		self.selenium.wait_for_text('Create new entry')
		self.selenium.click_text('Create new entry')
		self.selenium.wait_for_text('Internal name *')
		self.entry_name = uts.random_string()
		entry_dname = uts.random_string()
		self.selenium.enter_input('name', self.entry_name)
		self.selenium.click_button('Next')
		self.selenium.wait_until_standby_animation_appears_and_disappears()
		self.selenium.click_button('Next')
		self.selenium.enter_input('__displayName-0-1', entry_dname)
		self.selenium.click_button('Next')
		self.selenium.enter_input('__link-0-0', 'foo')
		self.selenium.click_button('Next')
		self.selenium.click_button('Finish')
		self.selenium.wait_until_all_dialogues_closed()
		self.selenium.wait_until_all_standby_animations_disappeared()
		logger.info('Check if the entry was created')
		try:
			self.selenium.wait_until_element_visible(expand_path('//h2[text()="%s"]/following-sibling::*//*[@containsClass="tile__name"][text()="%s"]' % (cat_dname, entry_dname)), timeout=10)
			udm.obj_by_dn('cn=%s,cn=entry,cn=portals,cn=univention,%s' % (self.entry_name, self.ucr['ldap/base']))
		except NoSuchElementException:
			try:
				udm.obj_by_dn('cn=%s,cn=entry,cn=portals,cn=univention,%s' % (self.entry_name, self.ucr['ldap/base']))
			except NoObject:
				raise CreationError('Creation of the settings/portal_entry UDM object failed')
			raise CreationError('A settings/portal_entry UDM object was created but the entry was not immediately visible in the portal')
		except NoObject:
			raise CreationError('Creation of the settings/portal_entry UDM object failed')

	def cleanup(self):
		logger.info('Cleanup')
		logger.info('Delete the UDM objects created via the portal')
		udm = UDM.admin().version(1)
		if hasattr(self, 'cat_name'):
			try:
				udm.obj_by_dn('cn=%s,cn=category,cn=portals,cn=univention,%s' % (self.cat_name, self.ucr['ldap/base'])).delete()
			except Exception:
				pass
		if hasattr(self, 'entry_name'):
			try:
				udm.obj_by_dn('cn=%s,cn=entry,cn=portals,cn=univention,%s' % (self.entry_name, self.ucr['ldap/base'])).delete()
			except Exception:
				pass
		if hasattr(self, 'prev_comps'):
			logger.info('Restore previously set portalComputers on main portal')
			udm = UDM.admin().version(1)
			portal = udm.obj_by_dn('cn=domain,cn=portal,cn=portals,cn=univention,{}'.format(ucr.get('ldap/base')))
			portal.props.portalComputers = self.prev_comps
			portal.save()


if __name__ == '__main__':
	with ucr_test.UCSTestConfigRegistry() as ucr, UCSTestUDM() as udm_test, selenium.UMCSeleniumTest() as s:
		umc_tester = UMCTester()
		umc_tester.ucr = ucr
		umc_tester.udm_test = udm_test
		umc_tester.selenium = s

		umc_tester.test_umc()

